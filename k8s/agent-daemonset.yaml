# LumaShield Agent DaemonSet
# Deploys an agent to every node in the cluster
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: lumashield-agent
  namespace: lumashield
  labels:
    app.kubernetes.io/name: lumashield
    app.kubernetes.io/component: agent
spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: lumashield
      app.kubernetes.io/component: agent
  updateStrategy:
    type: RollingUpdate
    rollingUpdate:
      maxUnavailable: 1
  template:
    metadata:
      labels:
        app.kubernetes.io/name: lumashield
        app.kubernetes.io/component: agent
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "9100"
    spec:
      serviceAccountName: lumashield-agent
      hostNetwork: true  # Required for XDP
      hostPID: true      # Required for BPF
      dnsPolicy: ClusterFirstWithHostNet
      tolerations:
        # Run on all nodes, including master
        - operator: Exists
      containers:
        - name: agent
          image: lumashield/agent:latest
          imagePullPolicy: Always
          securityContext:
            privileged: true  # Required for BPF/XDP
            capabilities:
              add:
                - SYS_ADMIN
                - NET_ADMIN
                - BPF
          env:
            - name: LUMASHIELD_AGENT_ID
              valueFrom:
                fieldRef:
                  fieldPath: spec.nodeName
            - name: LUMASHIELD_CONTROL_PLANE
              value: "control-plane.lumashield.svc.cluster.local:50051"
            - name: LUMASHIELD_INTERFACE
              value: "eth0"  # Adjust based on your node's interface
            - name: LUMASHIELD_LOG_LEVEL
              value: "info"
            - name: LUMASHIELD_BPF_PATH
              value: "/usr/share/lumashield/bpf/firewall.bpf.o"
          resources:
            requests:
              cpu: 100m
              memory: 64Mi
            limits:
              cpu: 500m
              memory: 256Mi
          volumeMounts:
            - name: bpf
              mountPath: /sys/fs/bpf
            - name: cgroup
              mountPath: /sys/fs/cgroup
      volumes:
        - name: bpf
          hostPath:
            path: /sys/fs/bpf
            type: DirectoryOrCreate
        - name: cgroup
          hostPath:
            path: /sys/fs/cgroup
            type: Directory
---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: lumashield-agent
  namespace: lumashield
  labels:
    app.kubernetes.io/name: lumashield
    app.kubernetes.io/component: agent
